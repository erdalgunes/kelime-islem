#!/bin/bash
# Pre-push hook to validate CI/CD configuration before pushing

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Running pre-push CI validation..."

# 1. Check workflow YAML syntax
echo "üìù Validating workflow YAML syntax..."
for workflow in .github/workflows/*.yml; do
    if [ -f "$workflow" ]; then
        if ! python3 -c "import yaml; yaml.safe_load(open('$workflow'))" 2>/dev/null; then
            echo -e "${RED}‚ùå Invalid YAML in $workflow${NC}"
            echo "Fix the YAML syntax before pushing!"
            exit 1
        fi
    fi
done

# 2. Validate GitHub Actions versions
echo "üîñ Checking GitHub Actions versions..."

# Run the action version validator
if [ -f scripts/validate-action-versions.sh ]; then
    if ! ./scripts/validate-action-versions.sh; then
        echo -e "${RED}‚ùå GitHub Action version validation failed!${NC}"
        echo "Fix the invalid action references before pushing."
        exit 1
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  Action version validator not found${NC}"
fi

# 3. Check for common CI issues
echo "üêõ Checking for common issues..."

# Known valid tasks that exist in this project
VALID_TASKS=":composeApp:testDebugUnitTest :composeApp:jsNodeTest :composeApp:lint :composeApp:assembleDebug :composeApp:jsBrowserDistribution :composeApp:koverVerify :composeApp:koverXmlReport :composeApp:koverHtmlReport :composeApp:allTests"

# Check if gradle tasks in workflows are valid (strip carriage returns)
GRADLE_TASKS=$(grep -h "gradlew" .github/workflows/*.yml 2>/dev/null | \
    grep -oE ":composeApp:[a-zA-Z]+" | \
    tr -d '\r' | \
    sort -u || true)

if [ ! -z "$GRADLE_TASKS" ]; then
    echo "  Validating Gradle tasks..."
    for task in $GRADLE_TASKS; do
        if [[ ! " $VALID_TASKS " =~ " $task " ]]; then
            echo -e "${YELLOW}  ‚ö†Ô∏è  Task '$task' may not exist${NC}"
        fi
    done
fi

# 4. Run act dry-run if available
if command -v act &> /dev/null; then
    echo "üé¨ Running act dry-run..."
    if ! act -n pull_request --job lint-and-analysis > /dev/null 2>&1; then
        echo -e "${YELLOW}‚ö†Ô∏è  act dry-run found potential issues${NC}"
        echo "Run 'act -n pull_request' to see details"
    fi
else
    echo -e "${YELLOW}‚ÑπÔ∏è  Install 'act' for local CI testing: brew install act${NC}"
fi

echo -e "${GREEN}‚úÖ Pre-push CI validation passed!${NC}"

# Run existing pre-push hook if it exists
if [ -f .git/hooks/pre-push.bak ]; then
    .git/hooks/pre-push.bak "$@"
fi

exit 0