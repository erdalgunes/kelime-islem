name: CodeRabbit to Codegen Integration

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write

jobs:
  trigger-codegen:
    name: Auto-trigger Codegen for CodeRabbit Issues
    runs-on: ubuntu-latest
    if: |
      github.event.comment.user.login == 'coderabbitai[bot]' &&
      (contains(github.event.comment.body, '‚ö†Ô∏è') ||
       contains(github.event.comment.body, 'üî¥') ||
       contains(github.event.comment.body, 'Potential issue') ||
       contains(github.event.comment.body, 'Critical') ||
       contains(github.event.comment.body, 'Major'))

    steps:
      - name: Trigger Codegen
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const commentUrl = context.payload.comment.html_url;

            // Extract the issue/suggestion from CodeRabbit comment
            const lines = comment.split('\n');
            const issueLine = lines.find(line =>
              line.includes('‚ö†Ô∏è') ||
              line.includes('üî¥') ||
              line.includes('**')
            ) || lines[0];

            // Create Codegen mention
            const codegenComment = `@codegen-sh Please fix the issue identified by CodeRabbit:\n\n${issueLine}\n\nReference: ${commentUrl}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: codegenComment
            });

      - name: React to CodeRabbit comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });