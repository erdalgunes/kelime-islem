name: CodeRabbit to Codegen Integration

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to trigger Codegen for'
        required: true
        type: number
      issue_description:
        description: 'Issue description for Codegen'
        required: true
        type: string

permissions:
  pull-requests: write
  issues: write

jobs:
  debug-payload:
    name: Debug Event Payload
    runs-on: ubuntu-latest
    steps:
      - name: Log Event Details
        env:
          EVENT_JSON: ${{ toJSON(github.event) }}
        run: |
          echo "=== EVENT DEBUGGING ==="
          echo "Event Type: ${{ github.event_name }}"
          echo "Event Action: ${{ github.event.action }}"
          echo "Comment User Login: ${{ github.event.comment.user.login }}"
          echo "Comment User Type: ${{ github.event.comment.user.type }}"
          echo "=== CONDITION TESTS ==="
          echo "Username match: ${{ github.event.comment.user.login == 'coderabbitai[bot]' }}"
          echo "Contains warning emoji: ${{ contains(github.event.comment.body, '‚ö†Ô∏è') }}"
          echo "Contains red circle: ${{ contains(github.event.comment.body, 'üî¥') }}"
          echo "Contains Potential issue: ${{ contains(github.event.comment.body, 'Potential issue') }}"
          echo "Contains Critical: ${{ contains(github.event.comment.body, 'Critical') }}"
          echo "=== COMMENT BODY ==="
          echo "First 500 chars of comment:"
          echo "${{ github.event.comment.body }}" | head -c 500
          echo ""
          echo "=== FULL PAYLOAD ==="
          echo "$EVENT_JSON"

  trigger-codegen:
    name: Auto-trigger Codegen for CodeRabbit Issues
    runs-on: ubuntu-latest
    if: |
      github.event.comment.user.login == 'coderabbitai[bot]' &&
      (contains(github.event.comment.body, '‚ö†Ô∏è') ||
       contains(github.event.comment.body, 'üî¥') ||
       contains(github.event.comment.body, 'Potential issue') ||
       contains(github.event.comment.body, 'Critical') ||
       contains(github.event.comment.body, 'Major'))

    steps:
      - name: Debug event data
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Comment user login: ${{ github.event.comment.user.login }}"
          echo "Comment body contains ‚ö†Ô∏è: ${{ contains(github.event.comment.body, '‚ö†Ô∏è') }}"
          echo "Comment body contains üî¥: ${{ contains(github.event.comment.body, 'üî¥') }}"
          echo "Comment body contains 'Potential issue': ${{ contains(github.event.comment.body, 'Potential issue') }}"

      - name: Trigger Codegen
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const commentUrl = context.payload.comment.html_url;

            // Extract the issue/suggestion from CodeRabbit comment
            const lines = comment.split('\n');
            const issueLine = lines.find(line =>
              line.includes('‚ö†Ô∏è') ||
              line.includes('üî¥') ||
              line.includes('**')
            ) || lines[0];

            // Create Codegen mention
            const codegenComment = `@codegen-sh Please fix the issue identified by CodeRabbit:

            ${issueLine}

            Reference: ${commentUrl}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: codegenComment
            });

      - name: React to CodeRabbit comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

  manual-codegen-trigger:
    name: Manual Codegen Trigger
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Trigger Codegen Manually
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.inputs.pr_number }};
            const issueDescription = "${{ github.event.inputs.issue_description }}";

            // Create Codegen mention for manual trigger
            const codegenComment = `@codegen-sh ${issueDescription}

            Manually triggered via GitHub Actions.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: codegenComment
            });

            console.log(`Posted manual Codegen trigger to PR #${prNumber}`);